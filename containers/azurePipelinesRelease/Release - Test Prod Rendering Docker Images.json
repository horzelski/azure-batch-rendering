{
  "source": 2,
  "revision": 25,
  "description": null,
  "createdBy": {
    "displayName": "David Kydd",
    "url": "https://app.vssps.visualstudio.com/A41b4f3ee-c651-4a14-9847-b7cbb5315b80/_apis/Identities/47bd54c4-e66a-4c40-932e-6a94d47771e8",
    "_links": {
      "avatar": {
        "href": "https://msazure.visualstudio.com/_apis/GraphProfile/MemberAvatars/aad.MWE4MWE0NmYtZTBjOC03N2EzLWEyNTQtZGJlYTg5YTE5NjEz"
      }
    },
    "id": "47bd54c4-e66a-4c40-932e-6a94d47771e8",
    "uniqueName": "dakydd@microsoft.com",
    "imageUrl": "https://msazure.visualstudio.com/_apis/GraphProfile/MemberAvatars/aad.MWE4MWE0NmYtZTBjOC03N2EzLWEyNTQtZGJlYTg5YTE5NjEz",
    "descriptor": "aad.MWE4MWE0NmYtZTBjOC03N2EzLWEyNTQtZGJlYTg5YTE5NjEz"
  },
  "createdOn": "2019-05-26T22:29:04.960Z",
  "modifiedBy": {
    "displayName": "David Kydd",
    "url": "https://app.vssps.visualstudio.com/A41b4f3ee-c651-4a14-9847-b7cbb5315b80/_apis/Identities/47bd54c4-e66a-4c40-932e-6a94d47771e8",
    "_links": {
      "avatar": {
        "href": "https://msazure.visualstudio.com/_apis/GraphProfile/MemberAvatars/aad.MWE4MWE0NmYtZTBjOC03N2EzLWEyNTQtZGJlYTg5YTE5NjEz"
      }
    },
    "id": "47bd54c4-e66a-4c40-932e-6a94d47771e8",
    "uniqueName": "dakydd@microsoft.com",
    "imageUrl": "https://msazure.visualstudio.com/_apis/GraphProfile/MemberAvatars/aad.MWE4MWE0NmYtZTBjOC03N2EzLWEyNTQtZGJlYTg5YTE5NjEz",
    "descriptor": "aad.MWE4MWE0NmYtZTBjOC03N2EzLWEyNTQtZGJlYTg5YTE5NjEz"
  },
  "modifiedOn": "2020-02-17T02:35:35.973Z",
  "isDeleted": false,
  "lastRelease": {
    "id": 830,
    "name": "Release-225",
    "artifacts": [],
    "_links": {},
    "description": "Scheduled release for pipeline 'Test Prod Rendering Docker Images'.",
    "releaseDefinition": {
      "id": 8,
      "projectReference": null,
      "_links": {}
    },
    "createdOn": "2020-02-24T14:00:07.287Z",
    "createdBy": {
      "displayName": "[msazure]\\Project Collection Service Accounts",
      "url": "https://app.vssps.visualstudio.com/A41b4f3ee-c651-4a14-9847-b7cbb5315b80/_apis/Identities/d64df6c1-8039-444b-8fc9-743114bd0430",
      "_links": {
        "avatar": {
          "href": "https://msazure.visualstudio.com/_apis/GraphProfile/MemberAvatars/vssgp.Uy0xLTktMTU1MTM3NDI0NS0yMjUzNzAwOTI5LTI0NTcwNDE0ODMtMjgxNjcxNDU0OS0zMzQ1NDc0NDgzLTAtMC0wLTAtMg"
        }
      },
      "id": "d64df6c1-8039-444b-8fc9-743114bd0430",
      "uniqueName": "vstfs:///Framework/Generic/41bf5486-7392-4b7a-a7e3-a735c767e3b3\\Project Collection Service Accounts",
      "imageUrl": "https://msazure.visualstudio.com/_apis/GraphProfile/MemberAvatars/vssgp.Uy0xLTktMTU1MTM3NDI0NS0yMjUzNzAwOTI5LTI0NTcwNDE0ODMtMjgxNjcxNDU0OS0zMzQ1NDc0NDgzLTAtMC0wLTAtMg",
      "isContainer": true,
      "descriptor": "vssgp.Uy0xLTktMTU1MTM3NDI0NS0yMjUzNzAwOTI5LTI0NTcwNDE0ODMtMjgxNjcxNDU0OS0zMzQ1NDc0NDgzLTAtMC0wLTAtMg"
    }
  },
  "variables": {
    "azureBatchRendering-branchName": {
      "value": "master",
      "allowOverride": true
    },
    "batchExtensionTemplates-branchName": {
      "value": "master",
      "allowOverride": true
    },
    "includeAntecendents": {
      "value": "false",
      "allowOverride": true
    },
    "includeDescendents": {
      "value": "true",
      "allowOverride": true
    },
    "targetRelativeDirs": {
      "value": "maya/centos7",
      "allowOverride": true
    },
    "testRegistry": {
      "value": "mcr.microsoft.com"
    },
    "testRepoBase": {
      "value": "$(testRegistry)/azure-batch/rendering"
    },
    "testRepoPassword": {
      "value": ""
    },
    "testRepoUsername": {
      "value": ""
    }
  },
  "variableGroups": [
    827,
    826
  ],
  "environments": [
    {
      "id": 9,
      "name": "Build and Validate",
      "rank": 1,
      "owner": {
        "displayName": "David Kydd",
        "url": "https://app.vssps.visualstudio.com/A41b4f3ee-c651-4a14-9847-b7cbb5315b80/_apis/Identities/47bd54c4-e66a-4c40-932e-6a94d47771e8",
        "_links": {
          "avatar": {
            "href": "https://msazure.visualstudio.com/_apis/GraphProfile/MemberAvatars/aad.MWE4MWE0NmYtZTBjOC03N2EzLWEyNTQtZGJlYTg5YTE5NjEz"
          }
        },
        "id": "47bd54c4-e66a-4c40-932e-6a94d47771e8",
        "uniqueName": "dakydd@microsoft.com",
        "imageUrl": "https://msazure.visualstudio.com/_apis/GraphProfile/MemberAvatars/aad.MWE4MWE0NmYtZTBjOC03N2EzLWEyNTQtZGJlYTg5YTE5NjEz",
        "descriptor": "aad.MWE4MWE0NmYtZTBjOC03N2EzLWEyNTQtZGJlYTg5YTE5NjEz"
      },
      "variables": {},
      "variableGroups": [],
      "preDeployApprovals": {
        "approvals": [
          {
            "rank": 1,
            "isAutomated": true,
            "isNotificationOn": false,
            "id": 25
          }
        ],
        "approvalOptions": {
          "requiredApproverCount": null,
          "releaseCreatorCanBeApprover": false,
          "autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped": false,
          "enforceIdentityRevalidation": false,
          "timeoutInMinutes": 0,
          "executionOrder": 1
        }
      },
      "deployStep": {
        "id": 26
      },
      "postDeployApprovals": {
        "approvals": [
          {
            "rank": 1,
            "isAutomated": true,
            "isNotificationOn": false,
            "id": 27
          }
        ],
        "approvalOptions": {
          "requiredApproverCount": null,
          "releaseCreatorCanBeApprover": false,
          "autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped": false,
          "enforceIdentityRevalidation": false,
          "timeoutInMinutes": 0,
          "executionOrder": 2
        }
      },
      "deployPhases": [
        {
          "deploymentInput": {
            "parallelExecution": {
              "parallelExecutionType": 0
            },
            "agentSpecification": null,
            "skipArtifactsDownload": false,
            "artifactsDownloadInput": {
              "downloadInputs": [
                {
                  "alias": "PublishContainerImages",
                  "artifactType": "Build",
                  "artifactDownloadMode": "All",
                  "artifactItems": []
                }
              ]
            },
            "queueId": 5233,
            "demands": [],
            "enableAccessToken": true,
            "timeoutInMinutes": 0,
            "jobCancelTimeoutInMinutes": 1,
            "condition": "succeeded()",
            "overrideInputs": {}
          },
          "rank": 1,
          "phaseType": 1,
          "name": "Agent job",
          "refName": null,
          "workflowTasks": [
            {
              "environment": {},
              "taskId": "e28912f1-0114-4464-802a-a3a35437fd16",
              "version": "1.*",
              "name": "Login to DockerHub",
              "refName": "",
              "enabled": false,
              "alwaysRun": false,
              "continueOnError": false,
              "timeoutInMinutes": 0,
              "definitionType": "task",
              "overrideInputs": {},
              "condition": "succeeded()",
              "inputs": {
                "containerregistrytype": "Container Registry",
                "dockerRegistryEndpoint": "862e55bc-5827-46e0-90cf-6ca272cc7b8d",
                "azureSubscriptionEndpoint": "",
                "azureContainerRegistry": "",
                "command": "login",
                "dockerFile": "**/Dockerfile",
                "arguments": "",
                "pushMultipleImages": "false",
                "tagMultipleImages": "false",
                "imageName": "$(Build.Repository.Name):$(Build.BuildId)",
                "imageNamesPath": "",
                "qualifyImageName": "true",
                "qualifySourceImageName": "false",
                "includeSourceTags": "false",
                "includeLatestTag": "false",
                "addDefaultLabels": "true",
                "useDefaultContext": "true",
                "buildContext": "",
                "imageDigestFile": "",
                "containerName": "",
                "ports": "",
                "volumes": "",
                "envVars": "",
                "workingDirectory": "",
                "entrypointOverride": "",
                "containerCommand": "",
                "runInBackground": "true",
                "restartPolicy": "no",
                "maxRestartRetries": "",
                "dockerHostEndpoint": "",
                "enforceDockerNamingConvention": "true",
                "memoryLimit": ""
              }
            },
            {
              "environment": {},
              "taskId": "d9bafed4-0b18-4f58-968d-86655b4d2ce9",
              "version": "2.*",
              "name": "Git Clone azure-batch-rendering",
              "refName": "",
              "enabled": true,
              "alwaysRun": false,
              "continueOnError": false,
              "timeoutInMinutes": 0,
              "definitionType": "task",
              "overrideInputs": {},
              "condition": "succeeded()",
              "inputs": {
                "script": "git clone -b $(azureBatchRendering-branchName) https://github.com/Azure/azure-batch-rendering.git azure-batch-rendering\n",
                "workingDirectory": "",
                "failOnStderr": "false"
              }
            },
            {
              "environment": {},
              "taskId": "d9bafed4-0b18-4f58-968d-86655b4d2ce9",
              "version": "2.*",
              "name": "Git Clone batch-extension-templates",
              "refName": "",
              "enabled": false,
              "alwaysRun": false,
              "continueOnError": false,
              "timeoutInMinutes": 0,
              "definitionType": "task",
              "overrideInputs": {},
              "condition": "succeeded()",
              "inputs": {
                "script": "git clone -b $(batchExtensionTemplates-branchName) https://github.com/Azure/batch-extension-templates.git batch-extension-templates\n",
                "workingDirectory": "",
                "failOnStderr": "false"
              }
            },
            {
              "environment": {},
              "taskId": "5541a522-603c-47ad-91fc-a4b1d163081b",
              "version": "2.*",
              "name": "Generate Test Files for Runner",
              "refName": "",
              "enabled": true,
              "alwaysRun": false,
              "continueOnError": false,
              "timeoutInMinutes": 120,
              "definitionType": "task",
              "overrideInputs": {},
              "condition": "succeeded()",
              "inputs": {
                "command": "custom",
                "publishWebProjects": "true",
                "projects": "",
                "custom": " PublishContainerImages.dll",
                "arguments": " test --testrepobase $(testRepoBase) --dockerinstallscriptsrootdir ../../azure-batch-rendering/docker --batchextensiontemplatesrootdir ../../batch-extension-templates/batch-extension-templates --targetrelativedirs \"$(targetRelativeDirs)\" --includeantecendents $(includeAntecendents) --includedescendents $(includeDescendents) ",
                "restoreArguments": "",
                "publishTestResults": "true",
                "testRunTitle": "",
                "zipAfterPublish": "true",
                "modifyOutputPath": "true",
                "selectOrConfig": "select",
                "feedRestore": "",
                "includeNuGetOrg": "true",
                "nugetConfigPath": "",
                "externalEndpoints": "",
                "noCache": "false",
                "packagesDirectory": "",
                "verbosityRestore": "Detailed",
                "searchPatternPush": "$(Build.ArtifactStagingDirectory)/*.nupkg",
                "nuGetFeedType": "internal",
                "feedPublish": "",
                "publishPackageMetadata": "true",
                "externalEndpoint": "",
                "searchPatternPack": "**/*.csproj",
                "configurationToPack": "$(BuildConfiguration)",
                "outputDir": "$(Build.ArtifactStagingDirectory)",
                "nobuild": "false",
                "includesymbols": "false",
                "includesource": "false",
                "versioningScheme": "off",
                "versionEnvVar": "",
                "requestedMajorVersion": "1",
                "requestedMinorVersion": "0",
                "requestedPatchVersion": "0",
                "buildProperties": "",
                "verbosityPack": "Detailed",
                "workingDirectory": "$(System.DefaultWorkingDirectory)/PublishContainerImages/PublishContainerImages"
              }
            },
            {
              "environment": {
                "DOCKER_CLI_EXPERIMENTAL": "enabled"
              },
              "taskId": "e213ff0f-5d5c-4791-802d-52ea3e7be1f1",
              "version": "2.*",
              "name": "Wait for tagged images to be listed",
              "refName": "",
              "enabled": false,
              "alwaysRun": false,
              "continueOnError": false,
              "timeoutInMinutes": 10,
              "definitionType": "task",
              "overrideInputs": {},
              "condition": "succeeded()",
              "inputs": {
                "targetType": "inline",
                "filePath": "",
                "arguments": "",
                "script": "docker login -u azurebatchrenderingservice -p ${Env:azurebatchrenderingservice-dockerhub}\n\n$taggedImages = Get-Content taggedImages.txt\n\nwhile ($taggedImages.Count -ge 1)\n{\n    echo \"Waiting for the following images to be available: $taggedImages\"\n    $missingImages = @()\n    foreach ($image in $taggedImages.GetEnumerator()) {\n        docker manifest inspect $image\n        if (!$?) { #if the image wasn't found (non zero exit code from docker manifest inspect) \n            $missingImages += $image\n        }\n    }\n    $taggedImages = $missingImages\n}",
                "errorActionPreference": "stop",
                "failOnStderr": "false",
                "ignoreLASTEXITCODE": "false",
                "pwsh": "false",
                "workingDirectory": ""
              }
            },
            {
              "environment": {},
              "taskId": "ec8bd6e1-aca5-46fc-9cc1-6aa46cb2a145",
              "version": "1.*",
              "name": "Task group: Execute batch-extension-templates Runner",
              "refName": "",
              "enabled": true,
              "alwaysRun": true,
              "continueOnError": true,
              "timeoutInMinutes": 0,
              "definitionType": "metaTask",
              "overrideInputs": {},
              "condition": "succeededOrFailed()",
              "inputs": {
                "BATCH_ACCOUNT_NAME": "$(BATCH_ACCOUNT_NAME)",
                "BATCH_ACCOUNT_SUB": "$(BATCH_ACCOUNT_SUBSCRIPTION_ID)",
                "BATCH_ACCOUNT_URL": "$(BATCH_ACCOUNT_URL)",
                "BatchAccountKey": "$(renderingbuildmwh01-batch)",
                "KEYVAULT_URL": "$(KEYVAULT_URL)",
                "SERVICE_PRINCIPAL_CLIENT_ID": "$(SERVICE_PRINCIPAL_CLIENT_ID)",
                "SERVICE_PRINCIPAL_RESOURCE": "$(SERVICE_PRINCIPAL_RESOURCE)",
                "SERVICE_PRINCIPAL_TENANT": "$(SERVICE_PRINCIPAL_TENANT)",
                "ServicePrincipalCredentialsSecret": "$(renderingbuild-serviceprincipal)",
                "STORAGE_ACCOUNT_NAME": "$(STORAGE_ACCOUNT_NAME)",
                "StorageAccountKey": "$(renderingbuildmwh01-storage)",
                "TEST_CONFIG_FILE": "../../../PublishContainerImages/PublishContainerImages/OutputTests/testConfiguration.json"
              }
            }
          ]
        }
      ],
      "environmentOptions": {
        "emailNotificationType": "OnlyOnFailure",
        "emailRecipients": "release.environment.owner;release.creator",
        "skipArtifactsDownload": false,
        "timeoutInMinutes": 0,
        "enableAccessToken": false,
        "publishDeploymentStatus": true,
        "badgeEnabled": true,
        "autoLinkWorkItems": false,
        "pullRequestDeploymentEnabled": false
      },
      "demands": [],
      "conditions": [
        {
          "name": "ReleaseStarted",
          "conditionType": 1,
          "value": ""
        }
      ],
      "executionPolicy": {
        "concurrencyCount": 1,
        "queueDepthCount": 0
      },
      "schedules": [],
      "currentRelease": {
        "id": 830,
        "url": "https://msazure.vsrm.visualstudio.com/51fdf21c-945b-476f-b036-1302f3d9d863/_apis/Release/releases/830",
        "_links": {}
      },
      "retentionPolicy": {
        "daysToKeep": 30,
        "releasesToKeep": 3,
        "retainBuild": true
      },
      "processParameters": {},
      "properties": {
        "LinkBoardsWorkItems": {
          "$type": "System.String",
          "$value": "False"
        }
      },
      "preDeploymentGates": {
        "id": 0,
        "gatesOptions": null,
        "gates": []
      },
      "postDeploymentGates": {
        "id": 0,
        "gatesOptions": null,
        "gates": []
      },
      "environmentTriggers": [],
      "badgeUrl": "https://msazure.vsrm.visualstudio.com/_apis/public/Release/badge/51fdf21c-945b-476f-b036-1302f3d9d863/8/9"
    }
  ],
  "artifacts": [
    {
      "sourceId": "51fdf21c-945b-476f-b036-1302f3d9d863:119658",
      "type": "Build",
      "alias": "batch-extension-templates",
      "definitionReference": {
        "artifactSourceDefinitionUrl": {
          "id": "https://msazure.visualstudio.com/_permalink/_build/index?collectionId=41bf5486-7392-4b7a-a7e3-a735c767e3b3&projectId=51fdf21c-945b-476f-b036-1302f3d9d863&definitionId=119658",
          "name": ""
        },
        "defaultVersionBranch": {
          "id": "",
          "name": ""
        },
        "defaultVersionSpecific": {
          "id": "",
          "name": ""
        },
        "defaultVersionTags": {
          "id": "",
          "name": ""
        },
        "defaultVersionType": {
          "id": "latestType",
          "name": "Latest"
        },
        "definition": {
          "id": "119658",
          "name": "Azure.batch-extension-templates"
        },
        "definitions": {
          "id": "",
          "name": ""
        },
        "IsMultiDefinitionType": {
          "id": "False",
          "name": "False"
        },
        "project": {
          "id": "51fdf21c-945b-476f-b036-1302f3d9d863",
          "name": "AzureBatch"
        },
        "repository": {
          "id": "",
          "name": ""
        }
      },
      "isRetained": false
    },
    {
      "sourceId": "51fdf21c-945b-476f-b036-1302f3d9d863:75762",
      "type": "Build",
      "alias": "PublishContainerImages",
      "definitionReference": {
        "artifactSourceDefinitionUrl": {
          "id": "https://msazure.visualstudio.com/_permalink/_build/index?collectionId=41bf5486-7392-4b7a-a7e3-a735c767e3b3&projectId=51fdf21c-945b-476f-b036-1302f3d9d863&definitionId=75762",
          "name": ""
        },
        "defaultVersionBranch": {
          "id": "",
          "name": ""
        },
        "defaultVersionSpecific": {
          "id": "",
          "name": ""
        },
        "defaultVersionTags": {
          "id": "",
          "name": ""
        },
        "defaultVersionType": {
          "id": "latestType",
          "name": "Latest"
        },
        "definition": {
          "id": "75762",
          "name": "PublishContainerImagesUtil"
        },
        "definitions": {
          "id": "",
          "name": ""
        },
        "IsMultiDefinitionType": {
          "id": "False",
          "name": "False"
        },
        "project": {
          "id": "51fdf21c-945b-476f-b036-1302f3d9d863",
          "name": "AzureBatch"
        },
        "repository": {
          "id": "",
          "name": ""
        }
      },
      "isPrimary": true,
      "isRetained": false
    }
  ],
  "triggers": [
    {
      "schedule": {
        "jobId": "e2bcf275-339d-4147-9c58-e91c1b9135fb",
        "timeZoneId": "New Zealand Standard Time",
        "startHours": 3,
        "startMinutes": 0,
        "daysToRelease": 31
      },
      "triggerType": 2
    }
  ],
  "releaseNameFormat": "Release-$(rev:r)",
  "tags": [],
  "properties": {
    "DefinitionCreationSource": {
      "$type": "System.String",
      "$value": "ReleaseImport"
    },
    "IntegrateJiraWorkItems": {
      "$type": "System.String",
      "$value": "false"
    },
    "IntegrateBoardsWorkItems": {
      "$type": "System.String",
      "$value": "False"
    }
  },
  "id": 8,
  "name": "Test Prod Rendering Docker Images",
  "path": "\\RenderingContainerImages",
  "projectReference": null,
  "url": "https://msazure.vsrm.visualstudio.com/51fdf21c-945b-476f-b036-1302f3d9d863/_apis/Release/definitions/8",
  "_links": {
    "self": {
      "href": "https://msazure.vsrm.visualstudio.com/51fdf21c-945b-476f-b036-1302f3d9d863/_apis/Release/definitions/8"
    },
    "web": {
      "href": "https://msazure.visualstudio.com/51fdf21c-945b-476f-b036-1302f3d9d863/_release?definitionId=8"
    }
  }
}